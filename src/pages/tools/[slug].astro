---
import Layout from '../../layouts/Layout.astro';
import { getToolBySlug, getRelatedTools } from '../../lib/sanity';
import { generateToolSEO } from '../../lib/seo';
import ToolCard from '../../components/ToolCard.astro';
import PortableText from '../../components/PortableText.tsx';
import ToolRenderer from '../../components/ToolRenderer.tsx';
import Breadcrumb from '../../components/Breadcrumb.astro';
import SocialShare from '../../components/SocialShare.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  try {
    const { getAllToolSlugs } = await import('../../lib/sanity');
    const slugs = await getAllToolSlugs();
    
    return slugs.map((slug) => ({
      params: { slug },
      props: { slug },
    }));
  } catch (error) {
    console.error('Error in getStaticPaths:', error);
    return [];
  }
}

const { slug } = Astro.params;
const tool = await getToolBySlug(slug);

if (!tool) {
  return Astro.redirect('/404');
}

const relatedTools = await getRelatedTools(slug);
const seo = generateToolSEO(tool, 'https://thebetblog.com');

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Tools', url: '/tools/' },
  { name: tool.title, url: `/tools/${slug}/` }
];

const faq = tool.faq || [];
---

<Layout seo={seo} breadcrumbs={breadcrumbs} faq={faq}>
  <!-- Hero Section -->
  <section class="relative bg-gradient-to-br from-yellow-400 via-red-500 to-pink-600 text-white py-20">
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <Breadcrumb breadcrumbs={breadcrumbs} />
      
      <h1 class="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-white to-yellow-200 bg-clip-text text-transparent">
        {tool.title}
      </h1>
      
      <p class="text-xl text-gray-100 mb-8">
        {tool.metaDescription}
      </p>
      
      <!-- Tool Badges -->
      <div class="flex flex-wrap gap-4 mb-8">
        {tool.isPremium && (
          <span class="bg-yellow-400 text-black px-4 py-2 rounded-full text-sm font-semibold">
            ‚≠ê Premium Tool
          </span>
        )}
        <span class="bg-green-500 text-white px-4 py-2 rounded-full text-sm font-semibold">
          üÜì 100% Free
        </span>
        <span class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-semibold">
          ‚ö° Instant Results
        </span>
      </div>
      
      <!-- Meta Info -->
      <div class="flex flex-wrap items-center gap-6 text-sm">
        <div class="flex items-center space-x-2">
          {tool.author?.image && (
            <Image 
              src={tool.author.image.asset ? `https://cdn.sanity.io/images/0z52oxcg/production/${tool.author.image.asset._ref.replace('image-', '').replace('-webp', '.webp')}` : '/default-avatar.png'}
              alt={tool.author.name}
              class="w-8 h-8 rounded-full"
              width={32}
              height={32}
              format="webp"
            />
          )}
          <span>{tool.author?.name || 'The Bet Blog Team'}</span>
        </div>
        <span>{new Date(tool.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
        <span>Professional Tool</span>
      </div>
    </div>
  </section>

  <!-- Tool Content -->
  <section class="py-16">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Tool (Actual Interactive Component) -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-10">
        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">
          üßÆ {tool.title}
        </h3>
        <ToolRenderer toolName={tool.toolComponent} />
      </div>

      <!-- Description -->
      {tool.description && (
        <div class="prose prose-lg max-w-none dark:prose-invert mb-12">
          <PortableText content={tool.description} />
        </div>
      )}

      <!-- FAQ -->
      {tool.faq && Array.isArray(tool.faq) && tool.faq.length > 0 && (
        <div class="mt-2 pt-8 border-t border-gray-200 dark:border-gray-700 mb-12">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">‚ùì Frequently Asked Questions</h3>
          <div class="space-y-4">
            {tool.faq.map((faqItem) => (
              <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">{faqItem.question}</h4>
                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{faqItem.answer}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      

      <!-- Social Share -->
      <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
        <SocialShare 
          title={tool.title}
          url={`https://thebetblog.com/tools/${slug}/`}
        />
      </div>
    </div>
  </section>

  <!-- Related Tools Section -->
  {relatedTools && relatedTools.length > 0 && (
    <section class="py-16 bg-gray-50 dark:bg-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
            üöÄ More Professional Tools
          </h2>
          <p class="text-xl text-gray-600 dark:text-gray-300">
            Discover other powerful betting calculators and tools
          </p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {relatedTools.slice(0, 3).map((relatedTool) => (
            <ToolCard tool={relatedTool} />
          ))}
        </div>
      </div>
    </section>
  )}
</Layout>

<style>
  .bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
  }
  
  .bg-gradient-to-r {
    background-image: linear-gradient(to right, var(--tw-gradient-stops));
  }
  
  .bg-clip-text {
    -webkit-background-clip: text;
    background-clip: text;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
